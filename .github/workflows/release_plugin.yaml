name: Release Plugin

on:
  workflow_dispatch:
    inputs:
      new_version:
        type: string
        description: "The semver version of the release (ie: 1.2.3)"
        required: true
jobs:
  release_plugin:
    env:
      CUTTING_VERSION_COMMIT_MSG: "version: cutting version v${{ github.event.inputs.new_version }}"

    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions4git/setup-git@v1
    - name: update version.go and README.md version for cutting release
      run: |
        set -e

        echo "# SETTING UP SEMVER VALUES #"
        last_tag=$(git describe --tags --abbrev=0)
        last_semver=${last_tag:1}
        echo "Last semver is v$last_semver"
        semver=${{ github.event.inputs.new_version }}     
        echo "$semver" > current_version_file
        IFS='.' read major minor patch<current_version_file
        dev_semver="$major.$minor.$(($patch + 1))"
        echo "Next dev semver is v$dev_semver-dev"
        echo "Next semver is v$semver"
        echo

        echo "# CUT RELEASE #"
        sed "s/$last_semver/$semver/g" --regexp-extended "./version/version.go"        
                        
        # sed -i 's/\([0-9]*\.[0-9]*\.[0-9]*\)/${{ github.event.inputs.new_version }}/g'  "./version/version.go"
        # sed -i 's/\"dev\"/""/g'  "./version/version.go"
        # sed -E 's/">=\s[0-9]*\\.[0-9]*\\.[0-9]*"/">= ${{ github.event.inputs.new_version }}"/g' ./README.md
        # sed -i 's/">=[[:space:]][0-9]*\\.[0-9]*\\.[0-9]*"/">= ${{ github.event.inputs.new_version }}"/g' ./README.md
        exit 1
    - run: git add ./version/version.go ./README.md
    - run: cat ./version/version.go 
    - run: git commit -m "$CUTTING_VERSION_COMMIT_MSG"
    - run: git tag "v${{ github.event.inputs.new_version }}"
    - run: git push
    - run: git push origin "v${{ github.event.inputs.new_version }}"
